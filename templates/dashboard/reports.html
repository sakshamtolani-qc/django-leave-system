<!-- templates/dashboard/reports.html -->
{% extends 'base.html' %}

{% block title %}Reports{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-chart-bar me-2"></i>Leave Reports</h2>
    <button class="btn btn-outline-primary" onclick="window.print()">
        <i class="fas fa-print me-2"></i>Print Report
    </button>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row align-items-end">
            <div class="col-md-4">
                <label for="start_date" class="form-label">Start Date</label>
                <input type="date" class="form-control" name="start_date" id="start_date" 
                       value="{{ start_date|date:'Y-m-d' }}">
            </div>
            <div class="col-md-4">
                <label for="end_date" class="form-label">End Date</label>
                <input type="date" class="form-control" name="end_date" id="end_date" 
                       value="{{ end_date|date:'Y-m-d' }}">
            </div>
            <div class="col-md-4">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-filter me-2"></i>Apply Filters
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card primary">
            <div class="card-body text-center">
                <i class="fas fa-calendar-alt fa-2x mb-2"></i>
                <h3 class="mb-1">{{ total_applications }}</h3>
                <p class="mb-0">Total Applications</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card success">
            <div class="card-body text-center">
                <i class="fas fa-check-circle fa-2x mb-2"></i>
                <h3 class="mb-1">{% for stat in status_stats %}{% if stat.status == 'approved' %}{{ stat.count }}{% endif %}{% empty %}0{% endfor %}</h3>
                <p class="mb-0">Approved</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card warning">
            <div class="card-body text-center">
                <i class="fas fa-clock fa-2x mb-2"></i>
                <h3 class="mb-1">{% for stat in status_stats %}{% if stat.status == 'pending' %}{{ stat.count }}{% endif %}{% empty %}0{% endfor %}</h3>
                <p class="mb-0">Pending</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <i class="fas fa-times-circle fa-2x mb-2"></i>
                <h3 class="mb-1">{% for stat in status_stats %}{% if stat.status == 'rejected' %}{{ stat.count }}{% endif %}{% empty %}0{% endfor %}</h3>
                <p class="mb-0">Rejected</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Status Distribution Chart -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Status Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="statusChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Department Statistics -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-building me-2"></i>Department Statistics</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Department</th>
                                <th>Employees</th>
                                <th>Applications</th>
                                <th>Approved</th>
                                <th>Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dept in department_stats %}
                            <tr>
                                <td>{{ dept.department|default:"No Department" }}</td>
                                <td>{{ dept.total_employees }}</td>
                                <td>{{ dept.total_applications }}</td>
                                <td>{{ dept.approved_leaves }}</td>
                                <td>
                                    {% if dept.total_applications > 0 %}
                                        {% widthratio dept.approved_leaves dept.total_applications 100 %}%
                                    {% else %}
                                        0%
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-muted">No department data available</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Applications Table -->
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Applications Detail</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>Department</th>
                        <th>Leave Type</th>
                        <th>Duration</th>
                        <th>Days</th>
                        <th>Status</th>
                        <th>Applied On</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for leave in applications %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-user-circle fa-lg text-muted me-2"></i>
                                <div>
                                    <div class="fw-bold">{{ leave.employee.get_full_name|default:leave.employee.username }}</div>
                                    <small class="text-muted">{{ leave.employee.employee_id|default:"-" }}</small>
                                </div>
                            </div>
                        </td>
                        <td>{{ leave.employee.department|default:"-" }}</td>
                        <td>{{ leave.leave_type.name }}</td>
                        <td>
                            <small>{{ leave.start_date|date:"M d" }} - {{ leave.end_date|date:"M d, Y" }}</small>
                        </td>
                        <td>
                            <span class="badge bg-info">{{ leave.days_requested }}</span>
                        </td>
                        <td>
                            <span class="status-badge bg-primary">
                                {{ leave.get_status_display }}
                            </span>
                        </td>
                        <td>{{ leave.created_at|date:"M d, Y" }}</td>
                        <td>
                            <a href="{% url 'leaves:leave_detail' leave.pk %}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            No applications found for the selected date range
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Export Options -->
<div class="card mt-4">
    <div class="card-body">
        <h6><i class="fas fa-download me-2"></i>Export Options</h6>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-success" onclick="exportToCSV()">
                <i class="fas fa-file-csv me-2"></i>Export to CSV
            </button>
            <button type="button" class="btn btn-outline-primary" onclick="window.print()">
                <i class="fas fa-print me-2"></i>Print Report
            </button>
            <button type="button" class="btn btn-outline-info" onclick="emailReport()">
                <i class="fas fa-envelope me-2"></i>Email Report
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Status distribution chart
    const ctx = document.getElementById('statusChart').getContext('2d');
    const statusData = [
        {% for stat in status_stats %}
        {
            label: '{{ stat.status|capfirst }}',
            value: {{ stat.count }},
            color: {% if stat.status == 'approved' %}'#28a745'{% elif stat.status == 'pending' %}'#ffc107'{% elif stat.status == 'rejected' %}'#dc3545'{% else %}'#6c757d'{% endif %}
        },
        {% endfor %}
    ];
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: statusData.map(item => item.label),
            datasets: [{
                data: statusData.map(item => item.value),
                backgroundColor: statusData.map(item => item.color),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });
});

function exportToCSV() {
    // Simple CSV export functionality
    let csv = 'Employee,Department,Leave Type,Start Date,End Date,Days,Status,Applied On\n';
    
    {% for leave in applications %}
    csv += '"{{ leave.employee.get_full_name|default:leave.employee.username }}","{{ leave.employee.department|default:"-" }}","{{ leave.leave_type.name }}","{{ leave.start_date }}","{{ leave.end_date }}","{{ leave.days_requested }}","{{ leave.get_status_display }}","{{ leave.created_at|date:"M d, Y" }}"\n';
    {% endfor %}
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('hidden', '');
    a.setAttribute('href', url);
    a.setAttribute('download', 'leave_report_{{ start_date|date:"Y_m_d" }}_to_{{ end_date|date:"Y_m_d" }}.csv');
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

function emailReport() {
    alert('Email functionality would be implemented with backend email service');
}
</script>

<style>
@media print {
    .btn, .card-header button, .navbar, .sidebar {
        display: none !important;
    }
    .card {
        border: none !important;
        box-shadow: none !important;
    }
    .main-content {
        margin: 0 !important;
        padding: 0 !important;
    }
}
</style>
{% endblock %}