{% extends 'base.html' %}
{% load employee_extras %}

{% block title %}{{ employee.get_full_name|default:employee.username }} - Profile{% endblock %}

{% block content %}
<div class="row">
    <!-- Employee Information -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                {% if employee.get_profile_picture_url %}
                    <img src="{{ employee.get_profile_picture_url }}" alt="Profile" class="rounded-circle mb-3" style="width: 150px; height: 150px; object-fit: cover;">
                {% else %}
                    <i class="fas fa-user-circle fa-9x text-muted mb-3"></i>
                {% endif %}

                <h4>{{ employee.get_full_name|default:employee.username }}</h4>
                <p class="text-muted">{{ employee.get_role_display }}</p>
                <p class="text-muted">{{ employee.department|default:"No Department" }}</p>

                <div class="row text-center mt-3">
                    <div class="col-6">
                        <div class="border-end">
                            <h5 class="mb-0 text-primary">{{ employee.employee_id|default:"-" }}</h5>
                            <small class="text-muted">Employee ID</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <h5 class="mb-0 text-success">{{ employee.date_joined|date:"M Y" }}</h5>
                        <small class="text-muted">Joined</small>
                    </div>
                </div>

                <div class="mt-3">
                    {% if employee.is_active %}
                        <span class="badge bg-success">Active</span>
                    {% else %}
                        <span class="badge bg-secondary">Inactive</span>
                    {% endif %}
                </div>

                {% if can_edit %}
                    <div class="d-grid gap-2 mt-3">
                        {% if employee == user %}
                            <div class="btn-group" role="group">
                                <a href="{% url 'accounts:basic_profile' %}" class="btn btn-primary btn-sm">
                                    <i class="fas fa-user-edit me-1"></i>Basic Info
                                </a>
                                <a href="{% url 'employees:extended_profile' %}" class="btn btn-success btn-sm">
                                    <i class="fas fa-id-card me-1"></i>Extended Profile
                                </a>
                            </div>
                        {% endif %}

                        {% if user.role|default:'' in "hr,admin" or user.is_superuser %}
                            <div class="btn-group" role="group">
                                <a href="{% url 'documents:generate_id_card' employee_id=employee.id %}" class="btn btn-outline-info btn-sm">
                                    <i class="fas fa-id-card me-1"></i>ID Card
                                </a>
                                <a href="{% url 'documents:create_offer_letter' employee_id=employee.id %}" class="btn btn-outline-success btn-sm">
                                    <i class="fas fa-file-contract me-1"></i>Offer Letter
                                </a>
                            </div>
                            {% if employee != user %}
                                <a href="{% url 'employees:extended_profile_admin' user_id=employee.id %}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-edit me-1"></i>Edit Extended Profile
                                </a>
                            {% endif %}
                        {% endif %}

                        {% if user.is_superuser %}
                            <a href="/admin/accounts/user/{{ employee.id }}/change/" target="_blank" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-cogs me-2"></i>Admin Edit
                            </a>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Contact Information -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-address-book me-2"></i>Contact Information</h6>
            </div>
            <div class="card-body">
                <div class="small">
                    <div class="d-flex justify-content-between mb-2">
                        <span><i class="fas fa-envelope me-2 text-muted"></i>Email:</span>
                        <span>{{ employee.email|default:"-" }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span><i class="fas fa-phone me-2 text-muted"></i>Phone:</span>
                        <span>{{ employee.phone|default:"-" }}</span>
                    </div>
                    {% if employee.manager %}
                    <div class="d-flex justify-content-between">
                        <span><i class="fas fa-user-tie me-2 text-muted"></i>Manager:</span>
                        <span>{{ employee.manager.get_full_name|default:"-" }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Employee Details (Privacy Controlled) -->
        {% if profile %}
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-user me-2"></i>Employee Details</h6>
            </div>
            <div class="card-body">
                <div class="small">
                    {% if profile.date_of_birth and show_private_info %}
                    <div class="d-flex justify-content-between mb-2">
                        <span><i class="fas fa-birthday-cake me-2 text-muted"></i>Date of Birth:</span>
                        <span>{{ profile.date_of_birth|date:"M d, Y" }}</span>
                    </div>
                    {% endif %}

                    {% if profile.joining_date %}
                    <div class="d-flex justify-content-between mb-2">
                        <span><i class="fas fa-calendar-plus me-2 text-muted"></i>Joining Date:</span>
                        <span>{{ profile.joining_date|date:"M d, Y" }}</span>
                    </div>
                    {% endif %}

                    <div class="d-flex justify-content-between mb-2">
                        <span><i class="fas fa-user-check me-2 text-muted"></i>Status:</span>
                        <span>{{ profile.get_employment_status_display|default:"Active" }}</span>
                    </div>

                    {% if profile.emergency_contact_name and show_private_info %}
                    <div class="border-top pt-2 mt-2">
                        <strong class="text-muted">Emergency Contact (Private)</strong>
                        <div class="d-flex justify-content-between mb-1">
                            <span><i class="fas fa-user me-2 text-muted"></i>Name:</span>
                            <span>{{ profile.emergency_contact_name }}</span>
                        </div>
                        {% if profile.emergency_contact_phone %}
                        <div class="d-flex justify-content-between">
                            <span><i class="fas fa-phone-alt me-2 text-muted"></i>Phone:</span>
                            <span>{{ profile.emergency_contact_phone }}</span>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    {% if profile.salary and show_private_info %}
                    <div class="border-top pt-2 mt-2">
                        <div class="d-flex justify-content-between">
                            <span><i class="fas fa-dollar-sign me-2 text-muted"></i>Salary (Private):</span>
                            <span>${{ profile.salary|floatformat:2 }}</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Leave Balance -->
        {% if employee.leave_balance %}
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Leave Balance</h6>
            </div>
            <div class="card-body">
                <!-- Annual Leave -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Annual Leave</span>
                        <span class="fw-bold">{{ employee.leave_balance.annual_leave }}/10</span>
                    </div>
                    <div class="progress mb-2">
                        <div class="progress-bar" style="width: {% widthratio employee.leave_balance.annual_leave 10 100 %}%"></div>
                    </div>
                </div>

                <!-- Sick Leave -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Sick Leave</span>
                        <span class="fw-bold">{{ employee.leave_balance.sick_leave }}/3</span>
                    </div>
                    <div class="progress mb-2">
                        <div class="progress-bar bg-warning" style="width: {% widthratio employee.leave_balance.sick_leave 3 100 %}%"></div>
                    </div>
                </div>

                <!-- Casual Leave -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Casual Leave</span>
                        <span class="fw-bold">{{ employee.leave_balance.casual_leave }}/2</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar bg-info" style="width: {% widthratio employee.leave_balance.casual_leave 2 100 %}%"></div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Main Content -->
    <div class="col-md-8">
        <!-- Bio Section -->
        {% if profile.bio %}
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>About</h6>
            </div>
            <div class="card-body">
                <p>{{ profile.bio|linebreaks }}</p>
            </div>
        </div>
        {% endif %}

        <!-- Skills Section -->
        {% if skills_list %}
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-tools me-2"></i>Skills & Expertise</h6>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    {% for skill in skills_list %}
                    <span class="badge bg-primary">{{ skill }}</span>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Recent Leaves -->
        {% if recent_leaves %}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Recent Leave Applications</h6>
                <a href="{% url 'leaves:my_leaves' %}" class="btn btn-outline-primary btn-sm">View All</a>
            </div>
            <div class="card-body">
                {% for leave in recent_leaves %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <strong>{{ leave.leave_type.name }}</strong>
                        <small class="text-muted d-block">{{ leave.start_date }} to {{ leave.end_date }}</small>
                    </div>
                    <span class="badge bg-{% if leave.status == 'approved' %}success{% elif leave.status == 'pending' %}warning text-dark{% elif leave.status == 'hr_approved' %}info{% else %}danger{% endif %}">
                        {{ leave.get_status_display }}
                    </span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Performance Reviews -->
        {% if performance_reviews %}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Performance Reviews</h6>
                <a href="{% url 'performance:dashboard' %}" class="btn btn-outline-primary btn-sm">View All</a>
            </div>
            <div class="card-body">
                {% for review in performance_reviews %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <strong>{{ review.get_review_type_display }}</strong>
                        <small class="text-muted d-block">{{ review.review_period_end|date:"M Y" }}</small>
                    </div>
                    <div class="text-end">
                        <div class="rating-stars mb-1">
                            {% for i in "12345" %}
                            <i class="fas fa-star {% if review.overall_rating >= forloop.counter %}text-warning{% else %}text-muted{% endif %}" style="font-size: 0.8rem;"></i>
                            {% endfor %}
                        </div>
                        <small>{{ review.overall_rating|floatformat:1 }}/5.0</small>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Action Buttons -->
<div class="row mt-4">
    <div class="col-12 text-center">
        <a href="{% url 'employees:directory' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Directory
        </a>

        {% if employee != user %}
            <a href="mailto:{{ employee.email }}" class="btn btn-primary ms-2">
                <i class="fas fa-envelope me-2"></i>Send Email
            </a>
            {% if employee.phone %}
            <a href="tel:{{ employee.phone }}" class="btn btn-success ms-2">
                <i class="fas fa-phone me-2"></i>Call
            </a>
            {% endif %}
        {% endif %}

        {% if user.role|default:'' in "hr,admin,manager" or user.is_superuser %}
        <a href="{% url 'performance:create_review' employee_id=employee.id %}" class="btn btn-info ms-2">
            <i class="fas fa-star me-2"></i>Create Review
        </a>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.rating-stars i { margin-right: 2px; }
</style>
{% endblock %}
